-- ============================================================================
-- ðŸ“Š RAZORPAY RECONCILIATION REPORT
-- ============================================================================

WITH provided_data (razorpay_payment_id, expected_amount, expected_status) AS (
  VALUES
  ('pay_RyuK8VDhKNtwpJ', 1, 'captured'),
  ('pay_RyxqMeDCpFR6V9', 1, 'refunded'),
  ('pay_RyyJCgsheAor78', 1, 'failed'),
  ('pay_RyyJyZCiI5uXLa', 1, 'failed'),
  ('pay_RyyKKys7aCptjQ', 1, 'refunded'),
  ('pay_Rzr3VsPOy3tRxH', 999, 'failed'),
  ('pay_S0OdGbTpuUU8xw', 999, 'failed'),
  ('pay_S0XKAM0PH24Oqd', 999, 'captured'),
  ('pay_S0ZfV08egCaDkj', 1999, 'refunded'),
  ('pay_S0ZgvCYBWXH1Vp', 1999, 'failed'),
  ('pay_S0Zn9vziKowFAQ', 1999, 'refunded'),
  ('pay_S0ZqaV5jUmaJPc', 1999, 'failed'),
  ('pay_S0Zqkaq10X0EUf', 1999, 'failed'),
  ('pay_S0a4zroErO03Go', 1999, 'refunded'),
  ('pay_S0a726Xw1leDRi', 1999, 'captured'),
  ('pay_S0aAWteMF7njPT', 1999, 'captured'),
  ('pay_S0aAnB6WuI4WWG', 2499, 'failed'),
  ('pay_S0aCitSieKfNgM', 2499, 'captured'),
  ('pay_S0aE70YLFdGbRu', 999, 'captured'),
  ('pay_S0aEJdBXWAvErZ', 1999, 'captured'),
  ('pay_S0aMCWi0aC1aEg', 999, 'captured'),
  ('pay_S0aPZQx1W5Qa2w', 999, 'captured'),
  ('pay_S0aS9hMPtVSyab', 1999, 'failed'),
  ('pay_S0aW6dsfDFLFbT', 1999, 'captured'),
  ('pay_S0ayBWfPTCvi5Y', 999, 'captured'),
  ('pay_S0b0eI5R1TNZsH', 999, 'captured'),
  ('pay_S0bGAWWmGbexQX', 1999, 'captured'),
  ('pay_S0bGrsz1VWGyNS', 1999, 'refunded'),
  ('pay_S0bWUGBtkTpUBl', 1999, 'failed'),
  ('pay_S0ba7A0hHZmnTi', 1999, 'refunded'),
  ('pay_S0bc4hh2VONw2Q', 1999, 'failed'),
  ('pay_S0brglLvwDASoP', 999, 'captured'),
  ('pay_S0c9XUhDJStGts', 999, 'captured'),
  ('pay_S0e9ZEWwBnRWpa', 999, 'captured'),
  ('pay_S0eTldXeXCEjly', 1999, 'captured'),
  ('pay_S0etvxJeq3m3i2', 2999, 'captured'),
  ('pay_S0euDqnvjIlQyL', 999, 'captured'),
  ('pay_S0euUm2FIlHxWK', 1999, 'captured'),
  ('pay_S0f0laRkh50TWE', 999, 'failed'),
  ('pay_S0f2wwxdBndRHy', 999, 'captured'),
  ('pay_S0f3HLX1u1ye1i', 999, 'failed'),
  ('pay_S0f5Qe4T0ANmwT', 999, 'failed'),
  ('pay_S0f8UuP6oi5qmO', 1999, 'captured'),
  ('pay_S0fAEMGGiAllQI', 999, 'captured'),
  ('pay_S0fEmFfKbooX58', 999, 'captured'),
  ('pay_S0fHHrCxChSXku', 999, 'captured'),
  ('pay_S0fOvhntjkC2CK', 1999, 'failed'),
  ('pay_S0fTqh5UTtrqkA', 1999, 'captured'),
  ('pay_S0fgCQM2y7rgU0', 1999, 'failed'),
  ('pay_S0fntFOo2WwkuX', 1999, 'failed'),
  ('pay_S0fotmY9UWflbn', 1999, 'captured'),
  ('pay_S0g11SorOWCB7x', 1999, 'captured'),
  ('pay_S0g2eDL2ACwOgO', 1999, 'failed'),
  ('pay_S0g5a1NDCpQnqp', 1999, 'failed'),
  ('pay_S0g6kFXNPO97iH', 1999, 'failed'),
  ('pay_S0g8oDv5ncn68d', 1999, 'failed'),
  ('pay_S0gSKRXWJ0xM0e', 1999, 'captured'),
  ('pay_S0i4HOoFpbshsd', 1999, 'failed'),
  ('pay_S0pqm3y51JspfR', 999, 'captured'),
  ('pay_S0rsKAzm3Dgh7G', 999, 'failed'),
  ('pay_S0rwSOf2V5RTuO', 999, 'failed'),
  ('pay_S0sKvC8CnjtPR8', 999, 'captured'),
  ('pay_S0sbbOq53gbuRn', 999, 'captured'),
  ('pay_S0sr32ToqEtOFm', 1999, 'captured'),
  ('pay_S0ssyLCQYW7YlG', 1999, 'failed'),
  ('pay_S0sv182LkaIwog', 1999, 'failed'),
  ('pay_S0szQYvT5ol7eQ', 1999, 'captured'),
  ('pay_S0u5eartbGjnmC', 1999, 'failed'),
  ('pay_S0uVxwWxztEPu5', 1999, 'captured'),
  ('pay_S0urzHl9HN58km', 1999, 'captured'),
  ('pay_S0vNTR7ViUFfOM', 999, 'captured'),
  ('pay_S0vmCTG5hR03Y0', 999, 'failed'),
  ('pay_S0vrRLsFuJ0DyP', 1999, 'captured'),
  ('pay_S0wUGkKcZ0oM2K', 999, 'captured'),
  ('pay_S0wiVlmyD02Npx', 1999, 'failed'),
  ('pay_S0wxulmyTWk2oC', 999, 'failed'),
  ('pay_S0x4jUkXj6PJ4Z', 999, 'captured'),
  ('pay_S0xaZhVkWjRKir', 999, 'captured'),
  ('pay_S0yLfCsh7uS77v', 1999, 'captured'),
  ('pay_S108XYt7Bleb5h', 1999, 'failed'),
  ('pay_S10QkxfCzv9t8l', 999, 'captured'),
  ('pay_S11Xcr4WH1l6e6', 1999, 'captured'),
  ('pay_S122rfsdL8gmJn', 1999, 'captured'),
  ('pay_S12iV9y4ibjRoF', 1999, 'captured'),
  ('pay_S13HVbqTySWklU', 999, 'captured'),
  ('pay_S13Z8LNQj8IBim', 2999, 'failed'),
  ('pay_S13e6P9ie4g2HN', 2999, 'captured'),
  ('pay_S13hiWKxnegBJp', 1999, 'captured'),
  ('pay_S14ILdUBr9vSYx', 1999, 'captured'),
  ('pay_S1Fh3T2OR4phzU', 1999, 'captured'),
  ('pay_S1GgQQyw1YwbpJ', 1999, 'captured'),
  ('pay_S1HLMDGuDapV8m', 1999, 'captured'),
  ('pay_S1Ibutc9cD7nEq', 1999, 'failed'),
  ('pay_S1IchnTjVIEagL', 1999, 'captured'),
  ('pay_S1JpV1OKApOGfr', 999, 'captured'),
  ('pay_S1KdMvGaXvYONM', 999, 'captured'),
  ('pay_S1KleTkypnFZo5', 1999, 'failed'),
  ('pay_S1L2JJbn0BcTG9', 1999, 'captured'),
  ('pay_S1M60sD3p1CjXO', 999, 'failed'),
  ('pay_S1MDaF48ueFhCB', 999, 'failed'),
  ('pay_S1NAplhVXcHkbB', 999, 'captured'),
  ('pay_S1Q28Ql7PMogp4', 1999, 'captured'),
  ('pay_S1QqPWMYqRovb6', 999, 'failed'),
  ('pay_S1RLHqzJtid1Ru', 999, 'captured'),
  ('pay_S1RbwZIaWT5Cyf', 999, 'failed'),
  ('pay_S1RizH1xU0XA0d', 1999, 'failed'),
  ('pay_S1Ru7R8QEHgI8y', 1999, 'captured'),
  ('pay_S1S7twe9vVu6B2', 999, 'failed'),
  ('pay_S1TJopCPIjbtJM', 999, 'captured'),
  ('pay_S1UZtv3KIKg1eW', 999, 'failed'),
  ('pay_S1bP6ud3K2qAud', 999, 'failed'),
  ('pay_S1c4YnisdqOsSV', 999, 'failed'),
  ('pay_S1fiWr6rb01Ui1', 999, 'captured'),
  ('pay_S1h3d4sMjrX5AE', 999, 'captured'),
  ('pay_S1kEhYTzLOKbpr', 999, 'captured'),
  ('pay_S1kcVhJKNaYOW6', 1999, 'captured'),
  ('pay_S1kfqZdNIClSYG', 1999, 'captured'),
  ('pay_S1nVJBxmqC5wZ1', 999, 'failed'),
  ('pay_S1nhE3vhNbv7OC', 999, 'failed'),
  ('pay_S1nxEEhbjRbUqj', 999, 'captured'),
  ('pay_S1oBuXiyWWeM7X', 1999, 'captured'),
  ('pay_S22gOvYY8VNVfq', 999, 'captured'),
  ('pay_S29X98EOVNVhxz', 1999, 'failed'),
  ('pay_S2UNyTcsAPGh68', 999, 'captured'),
  ('pay_S2Uw785hWiwUIM', 999, 'failed')
)
SELECT 
  p.razorpay_payment_id as "Payment ID",
  u.name as "User Name",
  u.email as "User Email",
  CASE 
      WHEN u.is_active THEN 'Active' 
      ELSE 'Inactive' 
  END as "User Status",
  p.expected_amount as "Expected",
  t.amount as "DB Amount",
  p.expected_status as "Razorpay",
  t.status as "DB Status",
  CASE 
    WHEN t.razorpay_payment_id IS NULL THEN 'Not Found in DB'
    WHEN t.status != p.expected_status THEN 'Status Mismatch'
    WHEN t.amount != p.expected_amount THEN 'Amount Mismatch'
    ELSE 'Match'
  END as "Verification"
FROM provided_data p
LEFT JOIN payments t ON p.razorpay_payment_id = t.razorpay_payment_id
LEFT JOIN users u ON t.user_id = u.id
ORDER BY "Verification", u.name;

-- Calculate Totals
WITH provided_data (razorpay_payment_id, expected_amount, expected_status) AS (
  VALUES
  ('pay_RyuK8VDhKNtwpJ', 1, 'captured'),
  ('pay_RyxqMeDCpFR6V9', 1, 'refunded'),
  ('pay_RyyJCgsheAor78', 1, 'failed'),
  ('pay_RyyJyZCiI5uXLa', 1, 'failed'),
  ('pay_RyyKKys7aCptjQ', 1, 'refunded'),
  ('pay_Rzr3VsPOy3tRxH', 999, 'failed'),
  ('pay_S0OdGbTpuUU8xw', 999, 'failed'),
  ('pay_S0XKAM0PH24Oqd', 999, 'captured'),
  ('pay_S0ZfV08egCaDkj', 1999, 'refunded'),
  ('pay_S0ZgvCYBWXH1Vp', 1999, 'failed'),
  ('pay_S0Zn9vziKowFAQ', 1999, 'refunded'),
  ('pay_S0ZqaV5jUmaJPc', 1999, 'failed'),
  ('pay_S0Zqkaq10X0EUf', 1999, 'failed'),
  ('pay_S0a4zroErO03Go', 1999, 'refunded'),
  ('pay_S0a726Xw1leDRi', 1999, 'captured'),
  ('pay_S0aAWteMF7njPT', 1999, 'captured'),
  ('pay_S0aAnB6WuI4WWG', 2499, 'failed'),
  ('pay_S0aCitSieKfNgM', 2499, 'captured'),
  ('pay_S0aE70YLFdGbRu', 999, 'captured'),
  ('pay_S0aEJdBXWAvErZ', 1999, 'captured'),
  ('pay_S0aMCWi0aC1aEg', 999, 'captured'),
  ('pay_S0aPZQx1W5Qa2w', 999, 'captured'),
  ('pay_S0aS9hMPtVSyab', 1999, 'failed'),
  ('pay_S0aW6dsfDFLFbT', 1999, 'captured'),
  ('pay_S0ayBWfPTCvi5Y', 999, 'captured'),
  ('pay_S0b0eI5R1TNZsH', 999, 'captured'),
  ('pay_S0bGAWWmGbexQX', 1999, 'captured'),
  ('pay_S0bGrsz1VWGyNS', 1999, 'refunded'),
  ('pay_S0bWUGBtkTpUBl', 1999, 'failed'),
  ('pay_S0ba7A0hHZmnTi', 1999, 'refunded'),
  ('pay_S0bc4hh2VONw2Q', 1999, 'failed'),
  ('pay_S0brglLvwDASoP', 999, 'captured'),
  ('pay_S0c9XUhDJStGts', 999, 'captured'),
  ('pay_S0e9ZEWwBnRWpa', 999, 'captured'),
  ('pay_S0eTldXeXCEjly', 1999, 'captured'),
  ('pay_S0etvxJeq3m3i2', 2999, 'captured'),
  ('pay_S0euDqnvjIlQyL', 999, 'captured'),
  ('pay_S0euUm2FIlHxWK', 1999, 'captured'),
  ('pay_S0f0laRkh50TWE', 999, 'failed'),
  ('pay_S0f2wwxdBndRHy', 999, 'captured'),
  ('pay_S0f3HLX1u1ye1i', 999, 'failed'),
  ('pay_S0f5Qe4T0ANmwT', 999, 'failed'),
  ('pay_S0f8UuP6oi5qmO', 1999, 'captured'),
  ('pay_S0fAEMGGiAllQI', 999, 'captured'),
  ('pay_S0fEmFfKbooX58', 999, 'captured'),
  ('pay_S0fHHrCxChSXku', 999, 'captured'),
  ('pay_S0fOvhntjkC2CK', 1999, 'failed'),
  ('pay_S0fTqh5UTtrqkA', 1999, 'captured'),
  ('pay_S0fgCQM2y7rgU0', 1999, 'failed'),
  ('pay_S0fntFOo2WwkuX', 1999, 'failed'),
  ('pay_S0fotmY9UWflbn', 1999, 'captured'),
  ('pay_S0g11SorOWCB7x', 1999, 'captured'),
  ('pay_S0g2eDL2ACwOgO', 1999, 'failed'),
  ('pay_S0g5a1NDCpQnqp', 1999, 'failed'),
  ('pay_S0g6kFXNPO97iH', 1999, 'failed'),
  ('pay_S0g8oDv5ncn68d', 1999, 'failed'),
  ('pay_S0gSKRXWJ0xM0e', 1999, 'captured'),
  ('pay_S0i4HOoFpbshsd', 1999, 'failed'),
  ('pay_S0pqm3y51JspfR', 999, 'captured'),
  ('pay_S0rsKAzm3Dgh7G', 999, 'failed'),
  ('pay_S0rwSOf2V5RTuO', 999, 'failed'),
  ('pay_S0sKvC8CnjtPR8', 999, 'captured'),
  ('pay_S0sbbOq53gbuRn', 999, 'captured'),
  ('pay_S0sr32ToqEtOFm', 1999, 'captured'),
  ('pay_S0ssyLCQYW7YlG', 1999, 'failed'),
  ('pay_S0sv182LkaIwog', 1999, 'failed'),
  ('pay_S0szQYvT5ol7eQ', 1999, 'captured'),
  ('pay_S0u5eartbGjnmC', 1999, 'failed'),
  ('pay_S0uVxwWxztEPu5', 1999, 'captured'),
  ('pay_S0urzHl9HN58km', 1999, 'captured'),
  ('pay_S0vNTR7ViUFfOM', 999, 'captured'),
  ('pay_S0vmCTG5hR03Y0', 999, 'failed'),
  ('pay_S0vrRLsFuJ0DyP', 1999, 'captured'),
  ('pay_S0wUGkKcZ0oM2K', 999, 'captured'),
  ('pay_S0wiVlmyD02Npx', 1999, 'failed'),
  ('pay_S0wxulmyTWk2oC', 999, 'failed'),
  ('pay_S0x4jUkXj6PJ4Z', 999, 'captured'),
  ('pay_S0xaZhVkWjRKir', 999, 'captured'),
  ('pay_S0yLfCsh7uS77v', 1999, 'captured'),
  ('pay_S108XYt7Bleb5h', 1999, 'failed'),
  ('pay_S10QkxfCzv9t8l', 999, 'captured'),
  ('pay_S11Xcr4WH1l6e6', 1999, 'captured'),
  ('pay_S122rfsdL8gmJn', 1999, 'captured'),
  ('pay_S12iV9y4ibjRoF', 1999, 'captured'),
  ('pay_S13HVbqTySWklU', 999, 'captured'),
  ('pay_S13Z8LNQj8IBim', 2999, 'failed'),
  ('pay_S13e6P9ie4g2HN', 2999, 'captured'),
  ('pay_S13hiWKxnegBJp', 1999, 'captured'),
  ('pay_S14ILdUBr9vSYx', 1999, 'captured'),
  ('pay_S1Fh3T2OR4phzU', 1999, 'captured'),
  ('pay_S1GgQQyw1YwbpJ', 1999, 'captured'),
  ('pay_S1HLMDGuDapV8m', 1999, 'captured'),
  ('pay_S1Ibutc9cD7nEq', 1999, 'failed'),
  ('pay_S1IchnTjVIEagL', 1999, 'captured'),
  ('pay_S1JpV1OKApOGfr', 999, 'captured'),
  ('pay_S1KdMvGaXvYONM', 999, 'captured'),
  ('pay_S1KleTkypnFZo5', 1999, 'failed'),
  ('pay_S1L2JJbn0BcTG9', 1999, 'captured'),
  ('pay_S1M60sD3p1CjXO', 999, 'failed'),
  ('pay_S1MDaF48ueFhCB', 999, 'failed'),
  ('pay_S1NAplhVXcHkbB', 999, 'captured'),
  ('pay_S1Q28Ql7PMogp4', 1999, 'captured'),
  ('pay_S1QqPWMYqRovb6', 999, 'failed'),
  ('pay_S1RLHqzJtid1Ru', 999, 'captured'),
  ('pay_S1RbwZIaWT5Cyf', 999, 'failed'),
  ('pay_S1RizH1xU0XA0d', 1999, 'failed'),
  ('pay_S1Ru7R8QEHgI8y', 1999, 'captured'),
  ('pay_S1S7twe9vVu6B2', 999, 'failed'),
  ('pay_S1TJopCPIjbtJM', 999, 'captured'),
  ('pay_S1UZtv3KIKg1eW', 999, 'failed'),
  ('pay_S1bP6ud3K2qAud', 999, 'failed'),
  ('pay_S1c4YnisdqOsSV', 999, 'failed'),
  ('pay_S1fiWr6rb01Ui1', 999, 'captured'),
  ('pay_S1h3d4sMjrX5AE', 999, 'captured'),
  ('pay_S1kEhYTzLOKbpr', 999, 'captured'),
  ('pay_S1kcVhJKNaYOW6', 1999, 'captured'),
  ('pay_S1kfqZdNIClSYG', 1999, 'captured'),
  ('pay_S1nVJBxmqC5wZ1', 999, 'failed'),
  ('pay_S1nhE3vhNbv7OC', 999, 'failed'),
  ('pay_S1nxEEhbjRbUqj', 999, 'captured'),
  ('pay_S1oBuXiyWWeM7X', 1999, 'captured'),
  ('pay_S22gOvYY8VNVfq', 999, 'captured'),
  ('pay_S29X98EOVNVhxz', 1999, 'failed'),
  ('pay_S2UNyTcsAPGh68', 999, 'captured'),
  ('pay_S2Uw785hWiwUIM', 999, 'failed')
)
SELECT 
  SUM(CASE WHEN expected_status = 'captured' THEN expected_amount ELSE 0 END) as "Total Revenue (Razorpay)",
  SUM(CASE WHEN expected_status = 'captured' AND t.status = 'captured' THEN expected_amount ELSE 0 END) as "Total Verified DB Revenue",
  COUNT(*) as "Total Transactions",
  SUM(CASE WHEN expected_status = 'captured' THEN 1 ELSE 0 END) as "Captured Count",
  SUM(CASE WHEN expected_status = 'failed' THEN 1 ELSE 0 END) as "Failed Count"
FROM provided_data p
LEFT JOIN payments t ON p.razorpay_payment_id = t.razorpay_payment_id;
